\documentclass[10pt, a4paper, twoside]{basestyle}

\usepackage{tikz}
\usetikzlibrary{cd}

\usepackage[Mathematics]{semtex}
\usepackage{chngcntr}
\counterwithout{equation}{section}

%%%% Shorthands.
\DeclareMathOperator{\bias}{\mathit{bias}}
\DeclareMathOperator{\ULP}{\mathfrak u}
\DeclareMathOperator{\mant}{\mathfrak m}
\DeclareMathOperator{\expn}{\mathfrak e}

% Rounding brackets will be heavily nested, and reading the nesting depth is critically important,
% so we make them grow for readability.
\newcommand{\round}[1]{\doubleSquareBrackets*{#1}}
\newcommand{\roundTowardZero}[1]{\doubleSquareBrackets{#1}_0}
\newcommand{\roundTowardPositive}[1]{\doubleSquareBrackets{#1}_+}
\newcommand{\roundTowardNegative}[1]{\doubleSquareBrackets{#1}_-}
\newcommand{\hex}[1]{{_{16}}\mathrm{#1}}
\newcommand{\bin}[1]{{_{2}}\mathrm{#1}}

%%%% Title and authors.

\title{An Implementation of Sin and Cos Using Gal's Accurate Tables}
\date{\printdate{2025-02-02}}
\author{Pascal~Leroy (phl)}
\begin{document}
\maketitle
\begin{sloppypar}
\noindent
This document describes the implementation of functions \texttt{Sin} and \texttt{Cos} in Principia.  The goals of that implementation are to be portable (including to machines that do not have a fused multiply-add instruction), achieve good performance, and ensure correct rounding.
\end{sloppypar}

\section*{Overview}
The implementation follows the ideas described by \cite{GalBachelis1991} and uses accurate tables produced by the method presented in \cite{StehléZimmermann2005}.  It guarantees correct rounding with a high probability.  In circumstances where it cannot guarantee correct rounding, it falls back to the (slower but correct) implementation provided by the CORE-MATH project \cite{SibidanovZimmermannGlondu2022} \cite{ZimmermannSibidanovGlondu2024}.  More precisely, the algorithm proceeds through the following steps:
\begin{itemize}[nosep]
\item perform argument reduction using Cody and Waite's algorithm in double precision (see \cite[379]{MullerBrisebarreDeDinechinJeannerodLefevreMelquiondRevolStehleTorres2010});
\item if argument reduction loses too many bits (i.e., the argument is close to a multiple of $\frac{\Pi}{2}$), fall back to \texttt{cr\_sin} or \texttt{cr\_cos};
\item otherwise, uses accurate tables and a polynomial approximation to compute \texttt{Sin} or \texttt{Cos} with extra accuracy;
\item if the result has a ``dangerous rounding configuration'' (as defined by \cite{GalBachelis1991}), fall back to \texttt{cr\_sin} or \texttt{cr\_cos};
\item otherwise return the rounded result of the preceding computation.
\end{itemize}
In this document we assume a base-2 floating-point number system with $M$ significand bits\footnote{In \texttt{binary64}, $M = 53$.} similar to the IEEE formats.  We define a real  function $\mant$ and an integer function $\expn$ denoting the \emph{significand} and \emph{exponent} of a real number, respectively:
\[
x = ±\mant\of{x} \times 2^{\expn\of{x}} \qquad\text{with}\qquad 2^{M-1} \leq \mant\of{x} \leq 2^M - 1
\]
Note that this representation is unique.  Furthermore, if $x$ is a floating-point number, $\mant\of{x}$ is an integer.

The distance between $1$ and the next larger floating-point number is:
\[
\ge_M \DefineAs 2^{1-M}
\]
and the distance between $1$ and the next smaller floating-point number is $\frac{\ge_M}{2}$.
The \emph{unit of the last place} of $x$ is defined as:
\[
\ULP\of{x} \DefineAs 2^{\expn\of{x}}
\]
In particular, $\ULP\of{1} = \ge_M$.

We ignore the exponent bias, overflow and underflow as they play no role in this discussion.

Finally, for error analysis we use the accuracy model of \cite{Higham2002}, equation (2.4): unless otherwise indicated, $\gd_i$ is a roundoff factor such that $\gd_i < u = \ge_M / 2 = 2^{-M}$ (see pages 37 and 38).  We also use $\gq_n$ and $\gg_n$ with the same meaning as in \cite{Higham2002}, lemma 3.1.

\section*{Argument Reduction}
Given an argument $x$, the purpose of argument reduction is to compute a pair of floating-point numbers $\pa{\hat x, \gd \hat x}$ such that:
\[
\begin{dcases}
\hat x + \gd \hat x ≅ x \pmod{\frac{\Pi}{2}} \\
\hat x \;\text{is approximately in}\; \intclos{-\frac{\Pi}{4}}{\frac{\Pi}{4}} \\
\abs{\gd \hat x} < \ULP\of{\hat x} 
\end{dcases}
\]
\subsection*{Approximation of $\Pi$}
We approximate $\frac{\Pi}{2}$ as the sum of two floating-point numbers:
\[
\frac{\Pi}{2} ≅ C + \gd C
\]
where $C$ is obtained by dropping the last $\gk_1$ mantissa bits of $\frac{\Pi}{2}$:
\[
C \DefineAs \floor{2^{-\gk_1} \mant \of{\frac{\Pi}{2}}} 2^{\gk_1} \ULP\of{\frac{\Pi}{2}}
\]
and $\gd C$ is defined as $\round{\frac{\Pi}{2} - C}$.  Obviously we have:
\[
0 < \frac{\Pi}{2} - C < 2^{\gk_1} \ULP\of{\frac{\Pi}{2}}
\]
but if $\gk_1$ is chosen to cut the significand of $\frac{\Pi}{2}$ at a place where it has zeroes, we can actually have a stricter bound:
\begin{align}
\frac{\Pi}{2} - C < 2^{\gk_2} \ULP\of{\frac{\Pi}{2}} \qquad\text{with}\qquad \gk_2 \leq \gk_1
\label{eqndC}
\end{align}
and therefore:
\[
\ULP\of{\frac{\Pi}{2} - C} < \frac{2^{\gk_2} \ULP\of{\frac{\Pi}{2}}}{\mant\of{\frac{\Pi}{2} - C}} \leq 2^{\gk_2 - M + 1} \ULP\of{\frac{\Pi}{2}} 
\]
Since the function $\ULP$ is always a power of $2$ this implies:
\[
\ULP\of{\frac{\Pi}{2} - C} = 2^{\gk_2 -M} \ULP\of{\frac{\Pi}{2}}
\]
and:
\begin{align}
\abs{\frac{\Pi}{2} - C - \gd C} \leq \frac{1}{2} \ULP\of{\frac{\Pi}{2} - C} = 2^{\gk_2 - M - 1} \ULP\of{\frac{\Pi}{2}}
\label{eqnpi}
\end{align}
In other words, we have a representation with a significand that has effectively $2 M - \gk_2$ bits and is such that multiplying $C$ by an integer less than or equal to $2^{\gk_1}$ is exact.  The representation of $\frac{\Pi}{2}$ has three zeroes after the 18th bit of its significand, so by taking $\gk_1 = 18$ we have $\gk_2 = 14$.

\subsection*{Argument Reduction for Small Angles}
If $\abs x < \round{\frac{\Pi}{4}}$ then $\hat x = x$ and $\gd \hat x = 0$.
\subsection*{Argument Reduction for Medium Angles}
If $\abs x \leq 2^{\gk_1} \round{\frac{\Pi}{2}}$ then we compute:
\[
\begin{dcases}
n &= \iround{\round{x \round{\frac{2}{\Pi}}}} \\
y &= x - n \; C \\
\gd y &= \round{n \; \gd C} \\
\hat x &= \round{y - \gd y} \\
\gd \hat x &= \pa{y - \hat x} - \gd y
\end{dcases}
\]
Let's first show that $\abs n \leq 2^{\gk_1}$. :
\begin{align*}
\abs x &\leq 2^{\gk_1} \frac{\Pi}{2} \pa{1 + \gd_1} \\
\abs n &\leq \iround{2^{\gk_1} \frac{\Pi}{2} \pa{1 + \gd_1} \frac{2}{\Pi} \pa{1 + \gd_2} \pa{1 + \gd_3}} \\
&\leq \iround{2^{\gk_1} \pa{1 + \gg_3}}
\end{align*}
Because $2^{\gk_1} \gg_3$ is very small (less that $2^{-33}$), the rounding cannot cause $n$ to exceed $2^{\gk_1}$.

The product $n \; C$ is exact thanks to the $\gk_1$ trailing zeroes of $C$.  The subtraction $x - n \; C$ is exact by Sterbenz's Lemma.  Finally, the last two steps form a compensated summation so that $\hat x + \gd \hat x = y + \gd y$.

To compute the overall error on argument reduction, first remember that, from equation \ref{eqnpi} we have:
\[
C + \gd C = \frac{\Pi}{2} + \gd_5 \quad \text{with} \quad \abs{\gd_5} \leq 2^{\gk_2 - M - 1} \ULP\of{\frac{\Pi}{2}}
\]
The error computation proceeds as follows:
\begin{align*}
y + \gd y &= x - n \; C - n \; \gd C \pa{1 + \gd_4} \\
&= x - n \pa{C + \gd C} - n \; \gd C \; \gd_4 \\
&= x - n \frac{\Pi}{2} -n \pa{\gd_5 + \gd C \; \gd_4}
\end{align*}
from which we can deduce an upper bound on the absolute error:
\[
\abs{y + \gd y - \pa{x - n \frac{\Pi}{2}}} < 2^{\gk_1} 2^{\gk_2} \ULP\of{\frac{\Pi}{2}} \pa{2^{- M - 1} + 2^{-M}} = \frac{3}{2} 2^{\gk_1 + \gk_2 - M} \ULP\of{\frac{\Pi}{2}}
\]
where we have used the upper bound for $\gd C$ given by equation \ref{eqndC}.

\subsection*{Argument Reduction for Large Angles}
\section*{Accurate Tables and Their Generation}
\section*{Computation of the Functions}
\subsection*{Sin}
\subsubsection*{Near Zero}
For $\hat x$ near zero we evaluate:
\begin{align*}
\widehat{x^2} &= \round{{\hat x}^2} = {\hat x}^2 \pa{1 + \gd_1}\\
\widehat{x^3} &= \round{\hat x \; \widehat{x^2}} = {\hat x}^3 \pa{1 + \gd_1} \pa{1 + \gd_2}\\
\hat p &= \round{a \widehat{x^2} + b} = \pa{a {\hat x}^2 \pa{1 + \gd_1} + b} \pa{1 + \gd_3}\\
s\of{x} &\DefineAs \hat x + \round{\round{\widehat{x^3} \hat p} + \gd \hat x} \\
&= \hat x + \pa{{\hat x}^3 \pa{1 + \gd_1} \pa{1 + \gd_2} \pa{a {\hat x}^2 \pa{1 + \gd_1} + b} \pa{1 + \gd_3} \pa{1 + \gd_4} + \gd \hat x}\pa{1 + \gd_5} \\
&= \hat x + a {\hat x}^3 \pa{1 + \gq_5} + b {\hat x}^5 \pa{1 + \gq_4} + \gd \hat x \pa{1 + \gd_5}
\end{align*}
\end{document}
